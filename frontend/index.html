<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MikroMon Dashboard</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card {
            background: #1e293b;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid #334155;
        }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            line-height: 2.5rem;
        }

        .modal-enter {
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 50;
            width: 250px;
            right: 0;
            background: #334155;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #475569;
            font-size: 0.75rem;
            color: #cbd5e1;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        .has-tooltip:hover .tooltip {
            visibility: visible;
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-100 font-sans p-4 min-h-screen">

    <!-- Setup Wizard (Existing) -->
    <div id="setupWizard" class="fixed inset-0 bg-slate-900 z-50 p-6 hidden flex flex-col justify-center">
        <div class="max-w-md mx-auto w-full">
            <h1 class="text-3xl font-black text-blue-500 mb-6 text-center">CONFIGURA√á√ÉO</h1>
            <div id="step1" class="space-y-4">
                <input type="text" id="rbName" placeholder="Nome do Provedor"
                    class="w-full bg-slate-800 border border-slate-700 p-3 rounded text-white focus:outline-none focus:border-blue-500">
                <input type="text" id="rbIp" placeholder="IP do MikroTik"
                    class="w-full bg-slate-800 border border-slate-700 p-3 rounded text-white focus:outline-none focus:border-blue-500">
                <input type="text" id="rbUser" placeholder="Utilizador"
                    class="w-full bg-slate-800 border border-slate-700 p-3 rounded text-white focus:outline-none focus:border-blue-500">
                <input type="password" id="rbPass" placeholder="Password"
                    class="w-full bg-slate-800 border border-slate-700 p-3 rounded text-white focus:outline-none focus:border-blue-500">
                <button onclick="checkConnection()"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded transition">CONECTAR</button>
                <p id="connError" class="text-red-400 text-sm text-center hidden"></p>
            </div>
            <div id="step2" class="space-y-4 hidden">
                <p class="text-slate-400 text-sm">Selecione a interface WAN:</p>
                <div id="ifaceList" class="bg-slate-800 rounded p-2 max-h-64 overflow-y-auto space-y-2"></div>
                <div class="pt-4">
                    <label class="text-slate-400 text-xs uppercase font-bold">Velocidade WAN (Mbps)</label>
                    <input type="number" id="wanSpeed" value="1000"
                        class="w-full bg-slate-700 border border-slate-600 p-2 rounded text-white mt-1">
                </div>
                <button onclick="saveConfig()"
                    class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded transition mt-4">SALVAR
                    CONFIGURA√á√ÉO</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal"
        class="fixed inset-0 bg-slate-900/95 z-40 p-4 hidden flex flex-col items-center justify-center backdrop-blur-sm modal-enter">
        <div
            class="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-md max-h-[80vh] flex flex-col shadow-2xl relative">
            <div
                class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800 rounded-t-2xl z-20">
                <div class="flex items-center space-x-2">
                    <h2 class="text-xl font-bold text-white">Backups</h2>
                    <!-- Info Icon with Tooltip -->
                    <div class="has-tooltip relative cursor-pointer text-slate-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="tooltip mt-2">
                            <h3 class="font-bold text-white mb-2">Pol√≠tica de Reten√ß√£o</h3>
                            <p class="mb-1">ü§ñ <strong class="text-emerald-400">Autom√°ticos:</strong></p>
                            <ul class="list-disc pl-4 space-y-1 mb-2 text-slate-300">
                                <li>7 dias: Todos (1/hora)</li>
                                <li>3 meses: 2/dia</li>
                                <li>3 anos: 1/dia</li>
                            </ul>
                            <p class="mb-1">üñêÔ∏è <strong class="text-blue-400">Manuais:</strong></p>
                            <ul class="list-disc pl-4 text-slate-300">
                                <li>Mantidos por 5 anos</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <button onclick="closeBackupModal()" class="text-slate-400 hover:text-white p-2">‚úï</button>
            </div>

            <!-- Manual Trigger -->
            <div class="p-4 border-b border-slate-700 bg-slate-900/50">
                <button id="btnManualBackup" onclick="triggerManualBackup()"
                    class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition flex justify-center items-center shadow-lg hover:shadow-blue-500/20">
                    CRIAR BACKUP AGORA
                </button>
                <p id="manualStatus" class="text-center text-xs text-slate-400 mt-2 hidden"></p>
            </div>

            <div id="backupList" class="overflow-y-auto p-4 space-y-3 flex-1"></div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <header class="mb-6 mt-4 text-center">
        <h1 id="headerTitle" class="text-3xl font-black text-blue-500 tracking-tight">MIKROMON <span
                class="text-white text-sm font-light">PROVEDOR</span></h1>
    </header>

    <div id="mainDashboard" class="grid grid-cols-1 gap-4 max-w-md mx-auto hidden pb-10">
        <!-- Backup Status -->
        <div onclick="openBackupModal()"
            class="card border-l-4 border-l-purple-500 flex justify-between items-center cursor-pointer hover:bg-slate-800 transition active:scale-95 relative overflow-hidden group">
            <div class="z-10">
                <h2 class="text-slate-400 text-xs uppercase tracking-widest font-bold mb-1">Backup Autom√°tico</h2>
                <p id="backupDate" class="text-sm font-bold text-white">--</p>
                <p id="nextBackupTimer" class="text-xs text-purple-300 font-mono mt-1">Carregando...</p>
            </div>
            <div class="bg-purple-500/10 p-2 rounded-full z-10 group-hover:bg-purple-500/20 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-400" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
            </div>
        </div>

        <!-- CPU Chart Card -->
        <div class="card relative overflow-hidden">
            <h2 class="text-slate-400 text-xs uppercase tracking-widest font-bold mb-2">Processamento</h2>
            <div class="flex justify-between items-end mb-2 relative z-10">
                <p id="cpu" class="stat-value text-blue-400">--%</p>
            </div>
            <div class="h-24 w-full"><canvas id="cpuChart"></canvas></div>
        </div>

        <!-- Traffic Chart Card -->
        <div class="card relative overflow-hidden">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-slate-400 text-xs uppercase tracking-widest font-bold">Tr√°fego WAN</h2>
                <div class="text-xs font-mono text-slate-500">RX: <span id="rx_val" class="text-emerald-400">--</span>
                    TX: <span id="tx_val" class="text-blue-400">--</span></div>
            </div>
            <div class="h-32 w-full"><canvas id="trafficChart"></canvas></div>
        </div>

        <!-- PPPoE & Memory -->
        <div class="grid grid-cols-2 gap-4">
            <div class="card border-l-4 border-l-green-500">
                <h2 class="text-slate-400 text-xs uppercase tracking-widest font-bold mb-1">Clientes</h2>
                <p id="pppoe" class="text-2xl font-black text-green-400">--</p>
            </div>
            <div class="card">
                <h2 class="text-slate-400 text-xs uppercase tracking-widest font-bold mb-1">Mem√≥ria</h2>
                <p id="mem" class="text-lg font-bold text-slate-300">-- MB</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="card">
                <h2 class="text-slate-400 text-xs uppercase tracking-widest font-bold mb-1">Temp</h2>
                <p id="temp" class="text-xl font-bold text-orange-400">--¬∞C</p>
            </div>
            <div class="card">
                <h2 class="text-slate-400 text-xs uppercase tracking-widest font-bold mb-1">Uptime</h2>
                <p id="uptime" class="text-xs font-mono">--</p>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const API_URL = 'http://' + window.location.hostname + ':5000';
        let interfaceData = [];
        let nextBackupTs = null;

        // --- Setup Logic (Existing) ---
        async function checkVerify() {
            try {
                const res = await fetch(API_URL + '/settings/verify');
                const data = await res.json();
                if (data.configured) {
                    document.getElementById('mainDashboard').classList.remove('hidden');
                    startDashboard();
                } else {
                    document.getElementById('setupWizard').classList.remove('hidden');
                    document.getElementById('headerTitle').classList.add('hidden');
                }
            } catch (e) { document.getElementById('setupWizard').classList.remove('hidden'); }
        }

        async function checkConnection() {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "A CONECTAR...";
            const payload = {
                ip: document.getElementById('rbIp').value,
                user: document.getElementById('rbUser').value,
                name: document.getElementById('rbName').value,
                password: document.getElementById('rbPass').value
            };
            try {
                const res = await fetch(API_URL + '/setup/connect', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                if (data.success) {
                    interfaceData = data.interfaces;
                    document.getElementById('step1').classList.add('hidden');
                    document.getElementById('step2').classList.remove('hidden');
                    const list = document.getElementById('ifaceList');
                    list.innerHTML = "";
                    interfaceData.forEach(iface => {
                        const div = document.createElement('div');
                        div.className = "flex items-center space-x-2 p-2 bg-slate-900 rounded cursor-pointer hover:bg-slate-700";
                        div.onclick = () => {
                            document.querySelectorAll('.iface-item').forEach(el => el.classList.remove('border-blue-500', 'border'));
                            div.classList.add('border', 'border-blue-500', 'iface-item');
                            div.dataset.selected = "true";
                        };
                        div.innerHTML = `<div class="w-4 h-4 rounded-full bg-slate-600"></div><span class="text-white font-bold">${iface.name}</span>`;
                        div.dataset.name = iface.name;
                        div.classList.add('iface-item');
                        list.appendChild(div);
                    });
                } else { throw new Error(data.error); }
            } catch (e) {
                document.getElementById('connError').innerText = "Erro: " + e.message;
                document.getElementById('connError').classList.remove('hidden');
            }
            btn.innerText = originalText;
        }

        async function saveConfig() {
            const selectedIface = document.querySelector('.iface-item[data-selected="true"]');
            if (!selectedIface) { alert("Selecione uma interface WAN!"); return; }
            const payload = {
                ip: document.getElementById('rbIp').value,
                user: document.getElementById('rbUser').value,
                name: document.getElementById('rbName').value,
                password: document.getElementById('rbPass').value,
                interfaces: [{
                    name: selectedIface.dataset.name,
                    speed: document.getElementById('wanSpeed').value,
                    is_wan: true,
                    monitor_pppoe: true
                }]
            };
            const res = await fetch(API_URL + '/setup/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const data = await res.json();
            if (data.success) location.reload();
        }

        // --- Backup Logic ---
        function openBackupModal() {
            document.getElementById('backupModal').classList.remove('hidden');
            fetchBackups();
        }

        function closeBackupModal() { document.getElementById('backupModal').classList.add('hidden'); }

        async function fetchBackups() {
            const listEl = document.getElementById('backupList');
            if (!listEl.innerHTML.includes('div')) listEl.innerHTML = '<p class="text-center text-slate-500 py-4">Carregando...</p>';
            try {
                const res = await fetch(API_URL + '/backups/list');
                const backups = await res.json();
                if (backups.length === 0) { listEl.innerHTML = '<p class="text-center text-slate-500 py-4">Nenhum backup encontrado.</p>'; return; }
                listEl.innerHTML = '';
                backups.forEach(backup => {
                    const isManual = backup.type === 'MANUAL';
                    const badgeClass = isManual ? 'bg-blue-600/20 text-blue-400 border-blue-600/50' : 'bg-emerald-600/20 text-emerald-400 border-emerald-600/50';
                    const badgeText = isManual ? 'MANUAL' : 'AUTO';

                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center bg-slate-900 p-3 rounded-xl border border-slate-700 hover:border-slate-600 transition";
                    item.innerHTML = `
                        <div>
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="text-xs font-bold px-1.5 py-0.5 rounded border ${badgeClass}">${badgeText}</span>
                                <p class="text-white font-bold text-sm">${backup.date}</p>
                            </div>
                            <p class="text-xs text-slate-500">${backup.size} ‚Ä¢ ${backup.filename}</p>
                        </div>
                        <button onclick="shareBackup('${backup.filename}')" class="bg-slate-800 text-slate-400 p-2 rounded-lg hover:bg-green-600 hover:text-white transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                        </button>`;
                    listEl.appendChild(item);
                });
            } catch (e) { listEl.innerHTML = '<p class="text-center text-red-400 py-4">Erro ao carregar lista.</p>'; }
        }

        async function triggerManualBackup() {
            const btn = document.getElementById('btnManualBackup');
            const status = document.getElementById('manualStatus');
            const originalText = btn.innerText;

            btn.disabled = true;
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> GERANDO BACKUP...`;
            status.innerText = "Conectando ao MikroTik...";
            status.classList.remove('hidden');

            try {
                const res = await fetch(API_URL + '/backups/run', { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    status.innerText = "Backup conclu√≠do! Baixando...";
                    setTimeout(() => {
                        status.classList.add('hidden');
                        btn.disabled = false;
                        btn.innerText = originalText;
                        fetchBackups(); // Refresh list
                    }, 1000);
                } else { throw new Error(data.error); }
            } catch (e) {
                status.innerText = "Erro: " + e.message;
                status.classList.add('text-red-400');
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function shareBackup(filename) {
            const url = API_URL + '/backups/download/' + filename;
            const text = `Backup MikroTik (${filename})`;
            if (navigator.share) { try { await navigator.share({ title: 'Backup MikroTik', text: text, url: url }); } catch (e) { } }
            else { window.open(`https://wa.me/?text=${encodeURIComponent(text + '\n' + url)}`, '_blank'); }
        }

        // --- Timer Logic (Existing) ---
        function updateTimer() {
            if (!nextBackupTs) return;
            const now = new Date().getTime();
            const target = new Date(nextBackupTs).getTime();
            const distance = target - now;

            if (distance < 0) {
                document.getElementById('nextBackupTimer').innerText = "Aguardando...";
            } else {
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                document.getElementById('nextBackupTimer').innerText = `Pr√≥ximo em: ${minutes}m ${seconds}s`;
            }
        }
        setInterval(updateTimer, 1000);

        // --- Dashboard Logic (Charts) ---
        let cpuChart, trafficChart;
        const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, elements: { point: { radius: 0 }, line: { tension: 0.4 } } };

        function initCharts() {
            const cpuCtx = document.getElementById('cpuChart').getContext('2d');
            cpuChart = new Chart(cpuCtx, { type: 'line', data: { labels: Array(30).fill(''), datasets: [{ label: 'CPU', data: Array(30).fill(0), borderColor: '#60a5fa', backgroundColor: 'rgba(96, 165, 250, 0.1)', fill: true, borderWidth: 2 }] }, options: { ...commonOptions, scales: { y: { min: 0, max: 100, display: false } } } });
            const trafficCtx = document.getElementById('trafficChart').getContext('2d');
            trafficChart = new Chart(trafficCtx, { type: 'line', data: { labels: Array(30).fill(''), datasets: [{ label: 'Download', data: Array(30).fill(0), borderColor: '#34d399', borderWidth: 2 }, { label: 'Upload', data: Array(30).fill(0), borderColor: '#60a5fa', borderWidth: 2 }] }, options: commonOptions });
        }

        async function fetchData() {
            try {
                const response = await fetch(API_URL + '/stats');
                if (response.status === 503) return;

                const data = await response.json();

                document.getElementById('headerTitle').innerHTML = `${data.router_name} <span class="text-white text-sm font-light">PROVEDOR</span>`;
                document.getElementById('cpu').innerText = data.cpu + '%';
                document.getElementById('pppoe').innerText = data.pppoe_active;
                document.getElementById('mem').innerText = (data.memory / 1024 / 1024).toFixed(0) + ' MB';
                document.getElementById('temp').innerText = data.temp !== 'N/A' ? data.temp + '¬∞C' : '--';
                document.getElementById('uptime').innerText = data.uptime;

                // Backup Status
                document.getElementById('backupDate').innerText = data.last_backup;
                if (data.next_backup) nextBackupTs = data.next_backup;

                const rxMbps = (data.rx_bps / 1000000);
                const txMbps = (data.tx_bps / 1000000);
                document.getElementById('rx_val').innerText = rxMbps.toFixed(1) + ' Mb';
                document.getElementById('tx_val').innerText = txMbps.toFixed(1) + ' Mb';

                if (cpuChart) {
                    cpuChart.data.datasets[0].data.shift(); cpuChart.data.datasets[0].data.push(data.cpu); cpuChart.update();
                    trafficChart.data.datasets[0].data.shift(); trafficChart.data.datasets[0].data.push(rxMbps);
                    trafficChart.data.datasets[1].data.shift(); trafficChart.data.datasets[1].data.push(txMbps); trafficChart.update();
                }

            } catch (e) { console.log("Erro na API:", e); }
        }

        function startDashboard() { initCharts(); fetchData(); setInterval(fetchData, 2000); }
        checkVerify();
    </script>
</body>

</html>